RewriteEngine On

# Force HTTPS
RewriteCond %{HTTPS} off
RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]

# Handle client-side routing
RewriteCond %{REQUEST_FILENAME} !-f
RewriteCond %{REQUEST_FILENAME} !-d
RewriteRule . /index.html [L]

# CRITICAL: Remove conflicting MIME types first
<IfModule mod_mime.c>
    RemoveType .js
    RemoveType .mjs
    RemoveType .jsx
    RemoveType .ts
    RemoveType .tsx
</IfModule>

# CRITICAL: Force correct MIME types - MOST AGGRESSIVE APPROACH
<IfModule mod_mime.c>
    AddType application/javascript .js .mjs .jsx .ts .tsx
    AddDefaultCharset utf-8
</IfModule>

# CRITICAL: Override ALL headers for JavaScript files - NUCLEAR OPTION
<IfModule mod_headers.c>
    # Remove any existing conflicting headers
    <FilesMatch "\.(js|mjs|jsx|ts|tsx)$">
        Header always unset Content-Type
        Header always unset Content-Encoding
        Header always unset Content-Disposition
        Header always unset Transfer-Encoding
        
        # Force the correct MIME type
        Header always set Content-Type "application/javascript; charset=utf-8"
        Header always set X-Content-Type-Options "nosniff"
        Header always set Cache-Control "public, max-age=31536000, immutable"
        
        # Prevent any server from overriding this
        Header always set X-Force-MIME-Type "application/javascript"
    </FilesMatch>
    
    # Specific targeting for Vite-generated files
    <FilesMatch "index-.*\.js$">
        Header always unset Content-Type
        Header always set Content-Type "application/javascript; charset=utf-8"
        Header always set X-MIME-Override "application/javascript"
    </FilesMatch>
    
    # Target main.tsx compiled files
    <FilesMatch "main.*\.js$">
        Header always unset Content-Type
        Header always set Content-Type "application/javascript; charset=utf-8"
        Header always set X-MIME-Override "application/javascript"
    </FilesMatch>
    
    # CSS files
    <FilesMatch "\.css$">
        Header always set Content-Type "text/css; charset=utf-8"
    </FilesMatch>
    
    # HTML files
    <FilesMatch "\.html$">
        Header always set Content-Type "text/html; charset=utf-8"
    </FilesMatch>
    
    # JSON files
    <FilesMatch "\.json$">
        Header always set Content-Type "application/json; charset=utf-8"
    </FilesMatch>
</IfModule>

# Security headers
<IfModule mod_headers.c>
    Header always set X-Frame-Options "DENY"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    Header always set Permissions-Policy "camera=(), microphone=(), geolocation=()"
</IfModule>

# Cache static assets
<IfModule mod_expires.c>
    ExpiresActive On
    ExpiresByType application/javascript "access plus 1 year"
    ExpiresByType text/css "access plus 1 year"
    ExpiresByType image/png "access plus 1 year"
    ExpiresByType image/jpg "access plus 1 year"
    ExpiresByType image/jpeg "access plus 1 year"
    ExpiresByType image/gif "access plus 1 year"
    ExpiresByType image/svg+xml "access plus 1 year"
    ExpiresByType font/woff2 "access plus 1 year"
    ExpiresByType font/woff "access plus 1 year"
</IfModule>

# Force server to recognize JavaScript files correctly
<IfModule mod_rewrite.c>
    # If a .js file is requested, make sure it's served as application/javascript
    RewriteCond %{REQUEST_URI} \.js$
    RewriteRule .* - [E=JS_FILE:1]
    Header always set Content-Type "application/javascript; charset=utf-8" env=JS_FILE
</IfModule> 